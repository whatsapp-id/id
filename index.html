<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WhatsApp Manager iOS</title>
    <!-- Font iOS System -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* === iOS THEME VARIABLES === */
            --ios-primary: #34C759; /* Apple Green */
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --ios-yellow: #FFCC00;
            --ios-gray: #8E8E93;
            --ios-purple: #AF52DE;
            
            /* Light Mode */
            --bg-body: #F2F2F7;
            --bg-card: #FFFFFF;
            --bg-glass: rgba(255, 255, 255, 0.85);
            --text-pri: #000000;
            --text-sec: #8A8A8E;
            --border: #E5E5EA;
            --separator: #C6C6C8;
            --input-bg: #E9E9EB;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --nav-bg: rgba(255, 255, 255, 0.9);
            --progress-bg: #E9E9EB;
        }

        /* Dark Mode */
        body.dark-mode {
            --bg-body: #000000;
            --bg-card: #1C1C1E;
            --bg-glass: rgba(28, 28, 30, 0.85);
            --text-pri: #FFFFFF;
            --text-sec: #98989D;
            --border: #38383A;
            --separator: #38383A;
            --input-bg: #2C2C2E;
            --shadow: 0 4px 20px rgba(0,0,0,0.4);
            --nav-bg: rgba(28, 28, 30, 0.9);
            --progress-bg: #3A3A3C;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-body); 
            color: var(--text-pri); 
            min-height: 100vh; 
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
            padding-bottom: 90px;
            padding-top: 60px;
        }

        /* === HEADER iOS STYLE === */
        .ios-header {
            position: fixed; top: 0; left: 0; width: 100%;
            height: 60px;
            background: var(--nav-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid var(--separator);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        .header-title { font-weight: 700; font-size: 18px; letter-spacing: -0.5px; }
        .header-btn { font-size: 18px; color: var(--ios-blue); background: none; border: none; cursor: pointer; }
        .header-btn.danger { color: var(--ios-red); }

        /* === WIDGETS & CARDS === */
        .content-container { padding: 20px; max-width: 600px; margin: 0 auto; }

        .card {
            background: var(--bg-card);
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        /* WIDGETS */
        .widget-clock { text-align: center; padding: 10px 0; margin-bottom: 20px; }
        .clock-time { font-size: 42px; font-weight: 200; letter-spacing: -1px; line-height: 1; }
        .clock-date { font-size: 14px; color: var(--text-sec); font-weight: 500; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }

        .stats-row { display: flex; gap: 12px; margin-bottom: 20px; }
        .stat-card {
            flex: 1; background: var(--bg-card); padding: 15px; border-radius: 16px; box-shadow: var(--shadow);
            text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .stat-icon { font-size: 20px; margin-bottom: 8px; }
        .stat-value { font-size: 16px; font-weight: 700; }
        .stat-label { font-size: 11px; color: var(--text-sec); margin-top: 2px; }
        .progress-mini { width: 100%; height: 4px; background: var(--input-bg); border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }

        /* === WINNER ALERT STYLE === */
        .winner-alert {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: black;
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
            animation: pulseGlow 2s infinite;
        }
        @keyframes pulseGlow {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        /* === LIST GROUP === */
        .ios-list { background: var(--bg-card); border-radius: 18px; overflow: hidden; box-shadow: var(--shadow); margin-bottom: 20px; }
        .ios-item {
            display: flex; align-items: center; justify-content: space-between; padding: 16px 20px;
            border-bottom: 0.5px solid var(--separator); background: var(--bg-card); cursor: pointer; transition: 0.2s;
        }
        .ios-item:last-child { border-bottom: none; }
        .ios-item:active { background: var(--input-bg); }
        .ios-icon {
            width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center;
            margin-right: 15px; color: white; font-size: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* === LOTTERY STYLES === */
        .lotto-card {
            background: var(--bg-card); border-radius: 18px; overflow: hidden; box-shadow: var(--shadow); margin-bottom: 20px; position: relative;
        }
        .lotto-img { width: 100%; height: 180px; object-fit: cover; }
        .lotto-body { padding: 15px; }
        .lotto-title { font-weight: 700; font-size: 18px; margin-bottom: 5px; }
        .lotto-meta { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-sec); margin-bottom: 10px; }
        .lotto-progress-bg { width: 100%; height: 10px; background: var(--progress-bg); border-radius: 5px; overflow: hidden; margin-bottom: 15px; }
        .lotto-progress-bar { height: 100%; background: linear-gradient(90deg, var(--ios-blue), var(--ios-purple)); border-radius: 5px; transition: width 0.5s; }
        .winner-badge {
            position: absolute; top: 15px; right: 15px; background: rgba(255, 204, 0, 0.9); color: black;
            padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 12px; backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); animation: bounceIn 0.5s;
        }
        @keyframes bounceIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        /* Participant List & Top Up List in Admin Modal */
        .part-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 0.5px solid var(--separator);
        }
        .part-info { font-size: 14px; }
        .part-sub { font-size: 11px; color: var(--text-sec); }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
        .badge-pending { background: var(--ios-yellow); color: black; }
        .badge-approved { background: var(--ios-primary); color: white; }
        .badge-rejected { background: var(--ios-red); color: white; }

        /* === BOTTOM NAV === */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 85px;
            background: var(--nav-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid var(--separator); display: flex; justify-content: space-around;
            align-items: flex-start; padding-top: 12px; z-index: 999;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sec); font-size: 10px; gap: 5px; cursor: pointer; width: 20%; transition: 0.2s; }
        .nav-item i { font-size: 22px; transition: 0.2s; }
        .nav-item.active { color: var(--ios-blue); }
        .nav-item.active i { transform: translateY(-2px); }

        /* === BUTTONS & INPUTS === */
        .btn { border: none; border-radius: 12px; padding: 12px 20px; font-weight: 600; font-size: 15px; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.97); opacity: 0.8; }
        .btn-block { width: 100%; }
        .btn-primary { background: var(--ios-blue); color: white; }
        .btn-success { background: var(--ios-primary); color: white; }
        .btn-danger { background: var(--ios-red); color: white; }
        .btn-purple { background: var(--ios-purple); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--text-sec); color: var(--text-pri); }
        
        .form-input {
            width: 100%; padding: 16px; background: var(--input-bg); border: none; border-radius: 12px;
            color: var(--text-pri); font-size: 16px; margin-bottom: 15px;
        }

        /* === MODALS === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: flex-end; justify-content: center;
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .modal-box {
            background: var(--bg-card); width: 100%; max-width: 600px; border-radius: 20px 20px 0 0;
            padding: 30px 20px 50px 20px; box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 90vh; overflow-y: auto;
        }
        .modal-handle { width: 40px; height: 5px; background: var(--separator); border-radius: 10px; margin: 0 auto 20px auto; }

        /* AUTH & OTHERS */
        .auth-container { height: 100vh; display: flex; flex-direction: column; justify-content: center; padding: 30px; background: var(--bg-body); }
        .auth-logo { font-size: 60px; color: var(--text-pri); margin-bottom: 20px; text-align: center; }
        .d-none { display: none !important; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-sec); font-size: 13px; }

        /* SLIDER CAPTCHA */
        .slider-captcha { width: 100%; height: 50px; background: var(--input-bg); border-radius: 25px; position: relative; margin-bottom: 20px; overflow: hidden; }
        .slider-handle { width: 50px; height: 50px; background: white; border-radius: 50%; position: absolute; top: 0; left: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; color: var(--text-sec); z-index: 2; }
        .slider-text { position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 13px; color: var(--text-sec); z-index: 1; }
        .slider-overlay { position: absolute; top:0; left:0; height:100%; background: var(--ios-primary); opacity: 0.3; }

        /* TOAST */
        .toast-container { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 99999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; }
        .toast { background: rgba(50,50,50,0.9); color: white; backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 50px; display: flex; align-items: center; gap: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-size: 14px; animation: fadeIn 0.3s; }

        /* SPLASH & ANIMATIONS */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .ios-splash { position: fixed; inset: 0; background: var(--bg-body); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; transition: 0.3s; }
        .splash-icon { font-size: 80px; color: var(--text-pri); margin-bottom: 20px; }
        .splash-title { font-size: 22px; font-weight: 700; margin-bottom: 5px; }
        .splash-sub { font-size: 13px; color: var(--text-sec); margin-bottom: 25px; }
        .splash-progress { width: 180px; height: 6px; background: var(--input-bg); border-radius: 10px; overflow: hidden; }
        .splash-bar { height: 100%; width: 0%; background: var(--ios-primary); animation: splashLoad 1.5s infinite; }
        @keyframes splashLoad { 0% { width: 0%; } 50% { width: 80%; } 100% { width: 0%; } }
    </style>
</head>
<body class="dark-mode">

    <!-- LOADING SCREEN -->
    <div id="loadingOverlay" class="ios-splash">
        <i class="fab fa-apple splash-icon"></i>
        <h2 class="splash-title">WhatsApp Manager</h2>
        <p class="splash-sub">Connecting to serverâ€¦</p>
        <div class="splash-progress"><div class="splash-bar" id="splashBar"></div></div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- AUTH SCREEN -->
    <div id="authScreen" class="auth-container d-none">
        <div class="text-center">
            <i class="fab fa-apple auth-logo"></i>
            <h2 style="margin-bottom: 5px;">WhatsApp Manager</h2>
            <p class="text-muted" style="margin-bottom: 40px;">Kelola Bot & Undian.</p>
        </div>

        <div id="loginView">
            <input id="u" class="form-input" placeholder="Username" autocomplete="off">
            <input type="password" id="p" class="form-input" placeholder="Password">
            
            <div class="slider-captcha" id="captchaContainer">
                <div class="slider-overlay" id="sliderOverlay"></div>
                <div class="slider-text" id="sliderText">Geser untuk verifikasi</div>
                <div class="slider-handle" id="sliderHandle"><i class="fas fa-arrow-right"></i></div>
            </div>

            <button onclick="login()" id="btnLogin" class="btn btn-primary btn-block" disabled>Masuk</button>
            <div class="text-center" style="margin-top: 20px;">
                <span class="text-muted">Belum punya akun?</span> <a href="#" onclick="switchAuth('reg')" style="color: var(--ios-blue); font-weight: 600; text-decoration: none;">Daftar</a>
            </div>
            <div class="text-center" style="margin-top: 15px;">
                <a href="#" onclick="switchAuth('reset')" style="color: var(--text-sec); font-size: 12px;">Lupa Password?</a>
            </div>
        </div>

        <div id="regForm" class="d-none">
            <input id="ru" class="form-input" placeholder="Username Baru">
            <input type="password" id="rp" class="form-input" placeholder="Password Baru">
            <button onclick="reg()" class="btn btn-success btn-block">Buat Akun</button>
            <button onclick="switchAuth('login')" class="btn btn-outline btn-block" style="margin-top: 10px;">Batal</button>
        </div>

        <div id="resetForm" class="d-none">
             <input id="rUser" class="form-input" placeholder="Username">
             <input id="rPhone" class="form-input" placeholder="Nomor Bot (628xxx)">
             <input type="password" id="rNewPass" class="form-input" placeholder="Password Baru">
             <button onclick="resetPass()" class="btn btn-danger btn-block">Reset</button>
             <button onclick="switchAuth('login')" class="btn btn-outline btn-block" style="margin-top: 10px;">Batal</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appContainer" class="d-none">
        <!-- HEADER -->
        <div class="ios-header">
            <div class="header-title">Dashboard</div>
            <div style="display: flex; gap: 15px;">
                <button class="header-btn" onclick="toggleDarkMode()" id="themeBtn"><i class="fas fa-moon"></i></button>
                <button class="header-btn danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div class="content-container">
            <!-- VIEW: DASHBOARD -->
            <div id="view-dash" class="view-section">
                
                <!-- JAM WIDGET -->
                <div class="widget-clock">
                    <div class="clock-time" id="clockTime">00:00</div>
                    <div class="clock-date" id="clockDate">Senin, 1 Januari 2024</div>
                </div>

                <!-- NOTIFIKASI PEMENANG (HIDDEN BY DEFAULT) -->
                <div id="winnerAlert" class="winner-alert d-none">
                    <div style="font-size: 30px;"><i class="fas fa-trophy"></i></div>
                    <div>
                        <h3 style="font-size: 16px; margin-bottom: 5px; font-weight: 800;">SELAMAT! ANDA MENANG!</h3>
                        <p style="font-size: 13px; line-height: 1.4;">
                            Anda telah memenangkan undian <b id="winItemName">...</b>.<br>
                            Harap hubungi admin: <br>
                            <a href="https://wa.me/6283879950760" target="_blank" style="font-weight: 700; color: black; text-decoration: underline;">
                                <i class="fab fa-whatsapp"></i> 6283879950760
                            </a>
                        </p>
                    </div>
                </div>

                <!-- SYSTEM STATS -->
                <div class="stats-row">
                    <div class="stat-card">
                        <i class="fas fa-memory stat-icon" style="color: var(--ios-blue);"></i>
                        <div class="stat-value" id="ramVal">45%</div>
                        <div class="stat-label">RAM</div>
                        <div class="progress-mini"><div class="progress-fill" style="width: 45%; background: var(--ios-blue);"></div></div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-microchip stat-icon" style="color: var(--ios-red);"></i>
                        <div class="stat-value" id="cpuVal">12%</div>
                        <div class="stat-label">CPU</div>
                        <div class="progress-mini"><div class="progress-fill" style="width: 12%; background: var(--ios-red);"></div></div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-battery-three-quarters stat-icon" style="color: var(--ios-primary);" id="battIcon"></i>
                        <div class="stat-value" id="battVal">--%</div>
                        <div class="stat-label">Baterai</div>
                        <div class="progress-mini"><div class="progress-fill" id="battFill" style="width: 0%; background: var(--ios-primary);"></div></div>
                    </div>
                </div>

                <!-- USER CARD & BALANCE -->
                <div class="card" style="display: flex; align-items: center; gap: 15px; padding: 15px; margin-bottom: 10px;">
                    <img id="p_img" src="https://ui-avatars.com/api/?name=User&background=random" style="width: 50px; height: 50px; border-radius: 50%;">
                    <div style="flex: 1;">
                        <div id="p_name" style="font-weight: 600; font-size: 16px;">Pengguna</div>
                        <div id="p_role" style="font-size: 12px; color: var(--text-sec); text-transform: uppercase;">User</div>
                        <!-- BALANCE DISPLAY -->
                        <div style="margin-top: 5px; font-size: 14px; font-weight: 500; color: var(--ios-primary); display: flex; align-items: center; gap: 5px;">
                            <span>Saldo: <span id="userBalance">Rp 0</span></span>
                            <button onclick="openModal('topupModal')" style="border: none; background: var(--ios-primary); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px;"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 12px; color: var(--text-sec);">Bots</div>
                        <div id="activeBots" style="font-weight: 700; font-size: 18px; color: var(--ios-primary);">0</div>
                    </div>
                </div>

                <!-- MENU LIST -->
                <div class="ios-list">
                    <div class="ios-item" onclick="view('bots')">
                        <div style="display: flex; align-items: center;">
                            <div class="ios-icon" style="background: linear-gradient(135deg, #34C759, #30B0C7);"><i class="fas fa-robot"></i></div>
                            <span style="font-weight: 500;">Kelola Bot</span>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-sec); font-size: 12px;"></i>
                    </div>
                    <div class="ios-item" onclick="view('dl')">
                        <div style="display: flex; align-items: center;">
                            <div class="ios-icon" style="background: linear-gradient(135deg, #007AFF, #5856D6);"><i class="fas fa-cloud-download-alt"></i></div>
                            <span style="font-weight: 500;">Downloader</span>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-sec); font-size: 12px;"></i>
                    </div>
                    <div class="ios-item" onclick="view('lotto')">
                        <div style="display: flex; align-items: center;">
                            <div class="ios-icon" style="background: linear-gradient(135deg, #AF52DE, #FF2D55);"><i class="fas fa-gift"></i></div>
                            <span style="font-weight: 500;">Undian Berhadiah</span>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-sec); font-size: 12px;"></i>
                    </div>
                </div>
            </div>

            <!-- VIEW: BOTS -->
            <div id="view-bots" class="view-section d-none">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="font-size: 18px;">Daftar Sesi</h3>
                    <button onclick="openModal('addModal')" class="btn btn-primary" style="padding: 8px 15px; font-size: 13px;"><i class="fas fa-plus"></i> Tambah</button>
                </div>
                <div id="botListContainer"></div>
            </div>

            <!-- VIEW: DOWNLOADER -->
            <div id="view-dl" class="view-section d-none">
                <div class="card">
                    <h3 style="margin-bottom: 10px;">Media Downloader</h3>
                    <p class="text-muted" style="margin-bottom: 15px;">TikTok, Instagram, YouTube</p>
                    <input id="dlUrl" class="form-input" placeholder="Tempel tautan di sini...">
                    <div style="display: flex; gap: 10px;">
                        <button onclick="doDownload('mp4')" class="btn btn-primary btn-block" id="btnMp4">Video</button>
                        <button onclick="doDownload('mp3')" class="btn btn-success btn-block" id="btnMp3">Musik</button>
                    </div>
                </div>
                <div id="dlResult" style="margin-top: 15px;"></div>
            </div>

            <!-- VIEW: LOTTERY -->
            <div id="view-lotto" class="view-section d-none">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="font-size: 18px;">Undian Aktif</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="btnManageTopup" onclick="manageTopups()" class="btn btn-primary d-none" style="padding: 8px 15px; font-size: 13px;"><i class="fas fa-wallet"></i> Cek Topup</button>
                        <button id="btnCreateLotto" onclick="openModal('createLottoModal')" class="btn btn-purple d-none" style="padding: 8px 15px; font-size: 13px;"><i class="fas fa-plus"></i> Barang</button>
                    </div>
                </div>
                <div id="lotteryListContainer">
                    <div class="text-center text-muted" style="padding: 30px;">Memuat data undian...</div>
                </div>
            </div>
        </div>
        
        <!-- BOTTOM NAVIGATION -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="view('dash')" id="nav-dash"><i class="fas fa-home"></i><span>Home</span></div>
            <div class="nav-item" onclick="view('bots')" id="nav-bots"><i class="fas fa-robot"></i><span>Bots</span></div>
            <div class="nav-item" onclick="view('dl')" id="nav-dl"><i class="fas fa-download"></i><span>Unduh</span></div>
            <div class="nav-item" onclick="view('lotto')" id="nav-lotto"><i class="fas fa-gift"></i><span>Undian</span></div>
        </div>
    </div>

    <!-- MODAL ADD BOT -->
    <div class="modal-overlay" id="addModal">
        <div class="modal-box">
            <div class="modal-handle"></div>
            <h3 class="text-center" style="margin-bottom: 20px;">Tautkan Perangkat</h3>
            <div id="addStep1">
                <input id="botPhone" type="tel" class="form-input" placeholder="Nomor: 628xxxxx" style="text-align: center; font-size: 18px; letter-spacing: 1px;">
                <button onclick="reqPair()" class="btn btn-success btn-block" style="margin-bottom: 10px;">Dapatkan Kode</button>
                <button onclick="closeModal('addModal')" class="btn btn-outline btn-block">Batal</button>
            </div>
            <div id="addStep2" class="d-none text-center">
                <p class="text-muted">Masukkan kode ini di WhatsApp Anda:</p>
                <div id="codeDisplay" style="font-family: monospace; font-size: 32px; letter-spacing: 5px; margin: 20px 0; font-weight: bold; color: var(--ios-primary);" onclick="copyCode()">...</div>
                <div id="pairStatus" class="text-muted" style="margin-bottom: 20px;">Menunggu koneksi...</div>
                <button onclick="closeModal('addModal')" class="btn btn-outline btn-block">Tutup</button>
            </div>
        </div>
    </div>

    <!-- MODAL TOP UP REQUEST -->
    <div class="modal-overlay" id="topupModal">
        <div class="modal-box">
            <div class="modal-handle"></div>
            <h3 class="text-center" style="margin-bottom: 10px;">Isi Saldo</h3>
            <p class="text-center text-muted" style="margin-bottom: 20px;">Minimal Rp 1.000</p>
            
            <input id="tpAmount" type="number" class="form-input" placeholder="Nominal (Cth: 20000)">
            <input id="tpSender" class="form-input" placeholder="Nama Pengirim">
            <input id="tpBank" class="form-input" placeholder="Nama Bank / E-Wallet">
            
            <div class="card" style="padding: 15px; text-align: center; margin-bottom: 15px;">
                <p class="text-muted" style="font-size: 12px; margin-bottom: 5px;">Scan QRIS di bawah untuk transfer</p>
                <img src="https://i.ibb.co.com/Qj8WX2RD/1764589851057.png" style="width: 150px; border-radius: 10px;">
            </div>

            <button onclick="submitTopup()" class="btn btn-success btn-block" style="margin-bottom: 10px;">Konfirmasi Transfer</button>
            <button onclick="closeModal('topupModal')" class="btn btn-outline btn-block">Batal</button>
        </div>
    </div>
    
    <!-- MODAL MANAGE TOPUPS (ADMIN) -->
    <div class="modal-overlay" id="manageTopupModal">
        <div class="modal-box">
            <div class="modal-handle"></div>
            <h3 class="text-center" style="margin-bottom: 20px;">Permintaan Top Up</h3>
            <div id="topupList"></div>
            <button onclick="closeModal('manageTopupModal')" class="btn btn-outline btn-block" style="margin-top: 20px;">Tutup</button>
        </div>
    </div>

    <!-- MODAL CREATE LOTTERY (ADMIN) -->
    <div class="modal-overlay" id="createLottoModal">
        <div class="modal-box">
            <div class="modal-handle"></div>
            <h3 class="text-center" style="margin-bottom: 20px;">Tambah Barang</h3>
            <input id="newItemName" class="form-input" placeholder="Nama Barang (contoh: iPhone 15)">
            <input id="newItemImg" class="form-input" placeholder="URL Gambar (Gunakan Direct Link ibb.co.com)">            
            <input id="newItemTarget" type="number" class="form-input" placeholder="Target Dana (Rp)">           
            <button onclick="createLotteryItem()" class="btn btn-purple btn-block" style="margin-bottom: 10px;">Posting Barang</button>
            <button onclick="closeModal('createLottoModal')" class="btn btn-outline btn-block">Batal</button>
        </div>
    </div>

    <!-- MODAL MANAGE PARTICIPANTS (ADMIN) -->
    <div class="modal-overlay" id="manageLottoModal">
        <div class="modal-box">
            <div class="modal-handle"></div>
            <h3 class="text-center" style="margin-bottom: 10px;">Kelola Peserta</h3>
            <p id="manageTitle" class="text-center text-muted" style="margin-bottom: 20px;">...</p>
            <div id="participantList" style="margin-bottom: 20px;"></div>
            <button id="btnSpin" class="btn btn-purple btn-block" style="margin-bottom: 10px;">Kocok Pemenang</button>
            <button id="btnDelete" class="btn btn-danger btn-block" style="margin-bottom: 10px;">Hapus Undian</button>
            <button onclick="closeModal('manageLottoModal')" class="btn btn-outline btn-block">Tutup</button>
        </div>
    </div>

    <!-- MODAL JOIN (INPUT DATA) -->
    <div class="modal-overlay" id="joinLottoModal">
        <div class="modal-box">
            <div class="modal-handle"></div>
            <h3 class="text-center" style="margin-bottom: 10px;">Ikut Patungan</h3>
            <p id="joinItemTitle" class="text-center text-muted" style="margin-bottom: 20px;">...</p>
            
            <label class="text-muted" style="font-size: 12px;">Nominal Patungan (Rp)</label>
            <input id="joinAmount" type="number" class="form-input" placeholder="Min 1.000" value="1000">
            
            <label class="text-muted" style="font-size: 12px;">Nomor WhatsApp Anda</label>
            <input id="joinPhone" type="tel" class="form-input" placeholder="628xxxx (Untuk konfirmasi)">
            
            <input type="hidden" id="joinItemId">
            
            <div class="text-center text-muted" style="font-size: 12px; margin-bottom: 15px;">
                Saldo Anda: <b id="joinCurrentBalance">Rp 0</b>
            </div>

            <button onclick="confirmJoinWallet()" class="btn btn-success btn-block" style="margin-bottom: 10px;">Bayar dengan Saldo</button>
            <button onclick="closeModal('joinLottoModal')" class="btn btn-outline btn-block">Batal</button>
        </div>
    </div>

    <script>
        // ==========================================
        // KONFIGURASI API
        // ==========================================
        const BIN_ID = '693151eed0ea881f40121ca6'; 
        const BIN_KEY = '$2a$10$u00Qvq6xrri32tc7bEYVhuQv94XS.ygeVCr70UDbzoOVlR8yLuUq.'; 
        // ==========================================
        
        let API_URL = '';
        let TOKEN = localStorage.getItem('auth_token');
        let USER_ROLE = 'user'; 
        let USER_NAME = 'User';
        let USER_BALANCE = 0;
        let USER_PHONE_CACHE = '';
        let isConnected = false;
        let isCaptchaVerified = false;

        // --- CLOCK & BATTERY ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clockTime').innerText = now.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' }).replace('.', ':');
            document.getElementById('clockDate').innerText = now.toLocaleDateString('id-ID', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
            if(Math.random() > 0.7) {
                const cpu = Math.floor(Math.random() * (40-5)+5);
                const ram = Math.floor(Math.random() * (60-30)+30);
                document.getElementById('cpuVal').innerText = cpu+'%';
                document.getElementById('ramVal').innerText = ram+'%';
                document.querySelectorAll('.stat-card')[0].querySelector('.progress-fill').style.width = ram+'%';
                document.querySelectorAll('.stat-card')[1].querySelector('.progress-fill').style.width = cpu+'%';
            }
        }
        async function updateBattery() {
            try {
                if(navigator.getBattery) {
                    const b = await navigator.getBattery();
                    const up = () => {
                        const l = Math.round(b.level*100);
                        document.getElementById('battVal').innerText = l+'%';
                        document.getElementById('battFill').style.width = l+'%';
                        const i = document.getElementById('battIcon');
                        if(b.charging) i.className = "fas fa-bolt stat-icon";
                        else if(l>75) i.className = "fas fa-battery-full stat-icon";
                        else if(l>50) i.className = "fas fa-battery-three-quarters stat-icon";
                        else if(l>25) i.className = "fas fa-battery-half stat-icon";
                        else i.className = "fas fa-battery-quarter stat-icon";
                    };
                    up(); b.addEventListener('levelchange', up); b.addEventListener('chargingchange', up);
                } else {
                    document.getElementById('battVal').innerText = '100%'; document.getElementById('battFill').style.width = '100%';
                }
            } catch(e){}
        }
        setInterval(updateClock, 1000); updateClock(); updateBattery();

        // --- INIT ---
        (function() {
            const th = localStorage.getItem('theme');
            if(th==='dark') document.body.classList.add('dark-mode');
            else if(th==='light') document.body.classList.remove('dark-mode');
        })();

        window.onload = async () => {
            const isDark = document.body.classList.contains('dark-mode');
            const btn = document.getElementById('themeBtn');
            if(btn) btn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            initSliderCaptcha(); await checkServerUrl();
        };

        function initSliderCaptcha() {
            const h = document.getElementById('sliderHandle');
            const c = document.getElementById('captchaContainer');
            const o = document.getElementById('sliderOverlay');
            const t = document.getElementById('sliderText');
            let drag = false, startX;
            const start = (e) => { if(isCaptchaVerified) return; drag = true; startX = (e.touches?e.touches[0].clientX:e.clientX); h.style.transition='none'; o.style.transition='none'; };
            const move = (e) => {
                if(!drag || isCaptchaVerified) return;
                let x = (e.touches?e.touches[0].clientX:e.clientX) - startX;
                let max = c.offsetWidth - h.offsetWidth;
                if(x<0) x=0; if(x>max) x=max;
                h.style.left = x+'px'; o.style.width = (x+25)+'px';
                if(x>=max-5) { isCaptchaVerified=true; drag=false; h.innerHTML='<i class="fas fa-check" style="color:var(--ios-primary)"></i>'; t.innerText="Terverifikasi"; document.getElementById('btnLogin').disabled=false; }
            };
            const stop = () => { if(isCaptchaVerified) return; drag=false; h.style.transition='0.3s'; o.style.transition='0.3s'; h.style.left='0px'; o.style.width='0px'; };
            h.addEventListener('mousedown', start); h.addEventListener('touchstart', start);
            document.addEventListener('mousemove', move); document.addEventListener('touchmove', move);
            document.addEventListener('mouseup', stop); document.addEventListener('touchend', stop);
        }

        // --- CORE API ---
        async function checkServerUrl() {
            try {
                const j = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': BIN_KEY } });
                const d = await j.json();
                let u = d.record.url.trim().replace(/\/$/, ""); if(!u.startsWith('http')) u='http://'+u; API_URL=u;
                const p = await fetch(API_URL + '/');
                if(p.ok || p.status===200 || p.status===404) {
                    isConnected=true; document.getElementById('loadingOverlay').classList.add('d-none');
                    if(TOKEN) checkAuthState(); else document.getElementById('authScreen').classList.remove('d-none');
                } else throw new Error();
            } catch(e) {
                isConnected=false; document.querySelector('.splash-sub').innerText = "Server Offline"; document.querySelector('.splash-sub').style.color="var(--ios-red)";
            }
        }
        function checkAuthState() {
            document.getElementById('authScreen').classList.add('d-none'); document.getElementById('appContainer').classList.remove('d-none'); loadData();
        }
        async function api(path, method='GET', body=null) {
            if(!API_URL||!isConnected) return {success:false, message:'Offline'};
            const o = { method, headers: { 'Content-Type': 'application/json' } };
            if(TOKEN) o.headers['Authorization'] = 'Bearer '+TOKEN; if(body) o.body = JSON.stringify(body);
            try { const r = await fetch(API_URL+path, o); if(r.status===401 && path!=='/api/login') { logout(); return {success:false}; } return await r.json(); } catch(e) { return {success:false, message:'Error'}; }
        }

        // --- LOGIN & DATA ---
        async function login() {
            if(!isCaptchaVerified) return showToast('Captcha!');
            const res = await api('/api/login', 'POST', {user:document.getElementById('u').value, pass:document.getElementById('p').value});
            if(res.success) { TOKEN=res.token; localStorage.setItem('auth_token', TOKEN); checkAuthState(); } else showToast(res.message);
        }
        
        async function loadData() {
            const d = await api('/api/data');
            if(!d || !d.user) return;
            USER_ROLE = d.role; USER_NAME = d.user;
            
            await checkWinnerStatus();

            document.getElementById('activeBots').innerText = d.activeBots?d.activeBots.length:0;
            if(USER_ROLE === 'admin') {
                document.getElementById('btnCreateLotto').classList.remove('d-none');
                document.getElementById('btnManageTopup').classList.remove('d-none');
            }
            
            const c = document.getElementById('botListContainer');
            const sess = d.role==='admin' ? d.sessions : d.sessions.filter(s=>d.meta[s]?.owner===d.user);
            c.innerHTML = '';
            if(sess.length===0) c.innerHTML = `<div class="text-center text-muted" style="padding:20px">Tidak ada bot aktif.</div>`;
            sess.forEach(s => {
                const act = d.activeBots.includes(s);
                c.innerHTML += `<div class="ios-list"><div class="ios-item" style="cursor:default"><div style="display:flex; align-items:center;"><div class="ios-icon" style="background:${act?'linear-gradient(135deg, #34C759, #30B0C7)':'var(--ios-gray)'}"><i class="fas ${act?'fa-wifi':'fa-slash'}"></i></div><div><div style="font-weight:600">+${s}</div><div class="text-muted" style="font-size:11px">${act?'Online':'Offline'}</div></div></div><div style="display:flex; gap:8px">${act?`<button onclick="action('${s}','stop')" class="btn btn-outline" style="padding:8px 12px"><i class="fas fa-stop"></i></button>`:`<button onclick="action('${s}','start')" class="btn btn-success" style="padding:8px 12px"><i class="fas fa-play"></i></button>`}<button onclick="action('${s}','delete')" class="btn btn-danger" style="padding:8px 12px"><i class="fas fa-trash"></i></button></div></div></div>`;
            });

            if(document.getElementById('p_name').innerText==='Pengguna') {
                const p = await api('/api/profile');
                if(p.name) {
                    document.getElementById('p_name').innerText = p.name;
                    document.getElementById('p_role').innerText = p.role;
                    document.getElementById('p_img').src = p.photoUrl || `https://ui-avatars.com/api/?name=${p.name}`;
                    // Update Balance
                    USER_BALANCE = p.balance || 0;
                    document.getElementById('userBalance').innerText = formatRupiah(USER_BALANCE);
                    if(p.phone) USER_PHONE_CACHE = p.phone;
                }
            } else {
                 // Refresh balance only if profile already loaded
                 const p = await api('/api/profile');
                 USER_BALANCE = p.balance || 0;
                 document.getElementById('userBalance').innerText = formatRupiah(USER_BALANCE);
            }
        }

        async function checkWinnerStatus() {
            try {
                const res = await api('/api/lottery');
                if(!res.success || !res.data) return;
                const wonItem = res.data.find(item => {
                    if(!item.winner) return false;
                    return item.winner.split(' (')[0] === USER_NAME;
                });
                if(wonItem) {
                    document.getElementById('winnerAlert').classList.remove('d-none');
                    document.getElementById('winItemName').innerText = wonItem.title;
                } else {
                    document.getElementById('winnerAlert').classList.add('d-none');
                }
            } catch(e) {}
        }

        // --- TOP UP SYSTEM ---
        async function submitTopup() {
            const amt = document.getElementById('tpAmount').value;
            const sender = document.getElementById('tpSender').value;
            const bank = document.getElementById('tpBank').value;
            
            if(!amt || !sender || !bank) return showToast('Isi semua data');
            if(amt < 1000) return showToast('Minimal Rp 1.000');
            
            const res = await api('/api/topup/request', 'POST', {amount: amt, bank: bank, sender: sender});
            if(res.success) {
                showToast(res.message);
                closeModal('topupModal');
            } else {
                showToast(res.message);
            }
        }

        async function manageTopups() {
            const res = await api('/api/topup/list');
            const list = document.getElementById('topupList');
            list.innerHTML = '';
            
            if(!res.data || res.data.length === 0) {
                list.innerHTML = '<p class="text-center text-muted">Tidak ada permintaan topup.</p>';
            } else {
                // Show Pending first
                const sorted = res.data.sort((a,b) => (a.status === 'pending' ? -1 : 1));
                
                sorted.forEach(t => {
                    let actions = '';
                    if(t.status === 'pending') {
                        actions = `
                            <button onclick="topupAction('${t.id}', 'approve')" style="color:var(--ios-primary); background:none; border:none; font-size:16px;"><i class="fas fa-check-circle"></i></button>
                            <button onclick="topupAction('${t.id}', 'reject')" style="color:var(--ios-red); background:none; border:none; font-size:16px;"><i class="fas fa-times-circle"></i></button>
                        `;
                    } else {
                        actions = `<span class="badge badge-${t.status}">${t.status}</span>`;
                    }
                    
                    list.innerHTML += `
                    <div class="part-item">
                        <div>
                            <div class="part-info"><b>${t.user}</b>: ${formatRupiah(t.amount)}</div>
                            <div class="part-sub">${t.senderName} (${t.bank})</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">${actions}</div>
                    </div>`;
                });
            }
            openModal('manageTopupModal');
        }

        async function topupAction(id, action) {
            if(!confirm(action + '?')) return;
            const res = await api('/api/topup/action', 'POST', {id, action});
            if(res.success) { showToast('Berhasil'); manageTopups(); loadData(); }
            else showToast(res.message);
        }

        // --- BOT ACTION ---
        async function action(ph, act) {
            if(act==='delete'&&!confirm('Hapus?')) return;
            const r = await api(`/api/${act}/${ph}`, 'POST');
            if(r.success) { showToast('Sukses'); loadData(); } else showToast(r.message);
        }
        async function reqPair() {
            const ph = document.getElementById('botPhone').value;
            if(!ph) return showToast('Isi Nomor');
            const r = await api('/api/add', 'POST', {phone:ph});
            if(r.success) { document.getElementById('addStep1').classList.add('d-none'); document.getElementById('addStep2').classList.remove('d-none'); pollCode(r.phone); } else showToast(r.message);
        }
        function pollCode(ph) {
            const i = setInterval(async()=>{
                const r = await api(`/api/code/${ph}`);
                if(r.code==='CONNECTED') { clearInterval(i); document.getElementById('codeDisplay').innerText="BERHASIL"; setTimeout(()=>{closeModal('addModal');loadData();},1500); }
                else if(r.code && r.code!=='WAITING') document.getElementById('codeDisplay').innerText=r.code;
            }, 3000);
        }
        
        // --- DOWNLOADER ---
        async function doDownload(t) {
            const u = document.getElementById('dlUrl').value;
            if(!u) return showToast('Isi URL');
            const b = document.getElementById(t==='mp4'?'btnMp4':'btnMp3');
            const og = b.innerHTML; b.innerHTML='...';
            const r = await api('/api/download', 'POST', {url:u, type:t});
            b.innerHTML = og;
            const d = document.getElementById('dlResult');
            if(r.success && r.data) {
                d.innerHTML = `<div class="card" style="padding:0"><img src="${r.data.thumbnail}" style="width:100%; height:150px; object-fit:cover;"><div style="padding:15px"><h4 style="font-size:14px; margin-bottom:10px">${r.data.title}</h4><a href="${r.data.url}" target="_blank" class="btn btn-primary btn-block">Download</a></div></div>`;
            } else d.innerHTML='<p class="text-muted text-center">Gagal</p>';
        }

        // --- LOTTERY SYSTEM ---
        let currentLottoId = null;

        async function renderLottery() {
            const c = document.getElementById('lotteryListContainer');
            c.innerHTML = '<div class="text-center text-muted" style="padding:20px">Memuat...</div>';
            const res = await api('/api/lottery');
            c.innerHTML = '';
            
            if(!res.success || res.data.length === 0) {
                c.innerHTML = '<p class="text-center text-muted" style="padding:20px">Belum ada undian aktif.</p>';
                return;
            }

            res.data.forEach(item => {
                const pct = Math.min((item.collected / item.target) * 100, 100);
                const isWinner = item.winner !== null;
                const isAdmin = (USER_ROLE === 'admin');
                
                let btnHtml = '';
                if (isWinner) {
                    // Tampilan Pemenang
                    btnHtml = `
                        <div style="background:var(--ios-primary); color:white; padding:10px; border-radius:10px; text-align:center; margin-bottom:10px;">
                            <i class="fas fa-trophy"></i> Menang: <b>${item.winner.split('(')[0]}</b>
                        </div>`;
                    
                    if (isAdmin) {
                        btnHtml += `
                        <div style="display:flex; gap:10px;">
                            <button onclick="recreateLottery(${item.id})" class="btn btn-success btn-block" style="font-size:12px;">
                                <i class="fas fa-redo"></i> Buat Ulang
                            </button>
                            <button onclick="deleteLottery(${item.id})" class="btn btn-danger btn-block" style="font-size:12px;">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>`;
                    }
                } 
                else if (isAdmin) {
                    // Admin: Kelola Peserta (Undian Aktif)
                    btnHtml = `<button onclick="manageLottery(${item.id})" class="btn btn-purple btn-block"><i class="fas fa-users-cog"></i> Kelola Peserta</button>`;
                } 
                else {
                    btnHtml = `<button onclick="openJoinModal(${item.id}, '${item.title}')" class="btn btn-primary btn-block"><i class="fas fa-wallet"></i> Gabung (Bayar Saldo)</button>`;
                }

                c.innerHTML += `
                <div class="lotto-card">
                    ${isWinner ? `<div class="winner-badge"><i class="fas fa-crown"></i> Selesai</div>` : ''}
                    <img src="${item.img}" class="lotto-img" referrerpolicy="no-referrer" onerror="this.src='https://via.placeholder.com/600x300?text=Gambar+Rusak'">
                    <div class="lotto-body">
                        <div class="lotto-title">${item.title}</div>
                        <div class="lotto-meta">
                            <span>Terkumpul: <b>${formatRupiah(item.collected)}</b></span>
                            <span>Target: <b>${formatRupiah(item.target)}</b></span>
                        </div>
                        <div class="lotto-progress-bg"><div class="lotto-progress-bar" style="width: ${pct}%"></div></div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:12px; color:var(--text-sec)">
                            <span>${pct.toFixed(1)}%</span>
                            <span>${item.participants.length} Peserta</span>
                        </div>
                        ${btnHtml}
                    </div>
                </div>`;
            });
        }

        async function createLotteryItem() {
            const name = document.getElementById('newItemName').value;
            const img = document.getElementById('newItemImg').value;
            const target = document.getElementById('newItemTarget').value;
            if(!name || !target) return showToast("Lengkapi data!");
            const res = await api('/api/lottery/create', 'POST', {title:name, img, target});
            if(res.success) { showToast("Dibuat!"); closeModal('createLottoModal'); renderLottery(); }
        }

        // --- JOIN FLOW (USING WALLET) ---
        function openJoinModal(id, title) {
            document.getElementById('joinItemId').value = id;
            document.getElementById('joinItemTitle').innerText = title;
            document.getElementById('joinPhone').value = USER_PHONE_CACHE || '';
            document.getElementById('joinCurrentBalance').innerText = formatRupiah(USER_BALANCE);
            
            // Warning if low balance
            if(USER_BALANCE < 1000) {
                 document.getElementById('joinCurrentBalance').innerHTML += ' <span style="color:var(--ios-red)">(Wajib Top Up!)</span>';
            }
            openModal('joinLottoModal');
        }

        async function confirmJoinWallet() {
            const id = parseInt(document.getElementById('joinItemId').value);
            const amt = parseInt(document.getElementById('joinAmount').value);
            const ph = document.getElementById('joinPhone').value;

            if(amt < 1000) return showToast("Minimal Rp 1.000");
            if(USER_BALANCE < amt) return showToast("Saldo tidak cukup! Silakan Top Up.");

            const res = await api('/api/lottery/join', 'POST', { id, amount: amt, phone: ph });
            if(res.success) {
                showToast(res.message);
                closeModal('joinLottoModal');
                loadData(); // Refresh balance
                renderLottery();
            } else {
                showToast(res.message);
            }
        }

        // --- ADMIN MANAGEMENT ---
        async function manageLottery(id) {
            const res = await api('/api/lottery');
            const item = res.data.find(x => x.id === id);
            if(!item) return;

            currentLottoId = id;
            document.getElementById('manageTitle').innerText = item.title;
            const list = document.getElementById('participantList');
            list.innerHTML = '';
            
            // Only show approved/paid participants
            const approvedCount = item.participants.filter(p => p.status === 'approved').length;
            const btnSpin = document.getElementById('btnSpin');
            
            if(item.collected >= item.target && approvedCount > 0 && !item.winner) {
                btnSpin.style.display = 'block';
                btnSpin.onclick = () => spinWinner(id);
            } else {
                btnSpin.style.display = 'none';
            }

            document.getElementById('btnDelete').onclick = () => deleteLottery(id);

            if(item.participants.length === 0) {
                list.innerHTML = '<p class="text-center text-muted">Belum ada peserta.</p>';
            } else {
                item.participants.forEach(p => {
                    // Since paying with wallet, status is always approved
                    let badge = `<span class="badge badge-approved">Paid</span>`;
                    list.innerHTML += `
                    <div class="part-item">
                        <div>
                            <div class="part-info"><b>${p.user}</b> (${p.phone})</div>
                            <div class="part-sub">${formatRupiah(p.amount)} â€¢ ${new Date(p.date).toLocaleDateString()}</div>
                        </div>
                        <div>${badge}</div>
                    </div>`;
                });
            }
            openModal('manageLottoModal');
        }

        async function spinWinner(id) {
            if(!confirm('Kocok pemenang sekarang?')) return;
            const res = await api('/api/lottery/spin', 'POST', { id });
            if(res.success) {
                showToast(`Pemenang: ${res.winner}`);
                closeModal('manageLottoModal');
                renderLottery();
            } else showToast(res.message);
        }
        async function deleteLottery(id) {
            if(!confirm('Hapus undian ini permanen?')) return;
            const res = await api('/api/lottery/delete', 'POST', { id });
            if(res.success) { showToast('Terhapus'); closeModal('manageLottoModal'); renderLottery(); }
        }
        
        // [BARU] Fungsi Buat Ulang
        async function recreateLottery(id) {
            if(!confirm('Buat ulang undian ini? (Target & Gambar akan sama, peserta di-reset)')) return;
            
            const res = await api('/api/lottery/recreate', 'POST', { id });
            if(res.success) { 
                showToast('Undian berhasil dibuat ulang!'); 
                renderLottery(); 
            } else {
                showToast(res.message);
            }
        }

        // --- UTILS ---
        function formatRupiah(n){ return new Intl.NumberFormat('id-ID', {style:'currency', currency:'IDR', minimumFractionDigits:0}).format(n); }
        function view(v) { document.querySelectorAll('.view-section').forEach(e=>e.classList.add('d-none')); document.getElementById('view-'+v).classList.remove('d-none'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); document.getElementById('nav-'+v).classList.add('active'); let t='Dashboard'; if(v==='bots')t='Manager Bot'; if(v==='dl')t='Downloader'; if(v==='lotto'){t='Undian'; renderLottery();} document.querySelector('.header-title').innerText=t; }
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light'); document.getElementById('themeBtn').innerHTML = document.body.classList.contains('dark-mode') ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; }
        function showToast(m) { const c=document.getElementById('toastContainer'); const t=document.createElement('div'); t.className='toast'; t.innerHTML=`<i class="fas fa-info-circle"></i> ${m}`; c.appendChild(t); setTimeout(()=>t.remove(),3000); }
        function openModal(id){document.getElementById(id).classList.add('active');} function closeModal(id){document.getElementById(id).classList.remove('active');}
        function logout(){localStorage.removeItem('auth_token');location.reload();}
        function switchAuth(t){document.getElementById('loginView').classList.add('d-none'); document.getElementById('regForm').classList.add('d-none'); document.getElementById('resetForm').classList.add('d-none'); if(t==='login')document.getElementById('loginView').classList.remove('d-none'); if(t==='reg')document.getElementById('regForm').classList.remove('d-none'); if(t==='reset')document.getElementById('resetForm').classList.remove('d-none');}
        async function reg(){const u=document.getElementById('ru').value;const p=document.getElementById('rp').value;const r=await api('/api/register','POST',{user:u,pass:p});if(r.success){showToast('Berhasil');switchAuth('login');}else showToast(r.message);}
        async function resetPass(){const u=document.getElementById('rUser').value;const ph=document.getElementById('rPhone').value;const np=document.getElementById('rNewPass').value;const r=await api('/api/reset-password','POST',{user:u,phone:ph,newPass:np});if(r.success){showToast('Reset Berhasil');switchAuth('login');}else showToast(r.message);}
        function copyCode(){navigator.clipboard.writeText(document.getElementById('codeDisplay').innerText);showToast('Disalin');}        
    </script>
</body>
</html>
